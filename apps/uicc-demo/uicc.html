
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="jquery.mobile-1.1.1.min.css" />
        <style>
            /* App custom styles */
            #output {
              width: 100%;
              min-height: 250px;
            }
        </style>
        <script src="jquery-1.7.1.min.js">
        </script>
        <script src="jquery.mobile-1.1.1.min.js">
        </script>
    </head>
    <body>
        <!-- Home -->
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    UICC Demo
                </h3>
            </div>
            <div data-role="content" style="padding: 15px">
                <div data-role="fieldcontain">
                    <fieldset data-role="controlgroup">
                        <label for="textarea1">
                            Output
                        </label></br>
                        <textarea name="" placeholder="" id="output">
                        </textarea>
                    </fieldset>
                </div>
                <a data-role="button" data-transition="fade" href="#page1" id="openbutton">
                    Open Channel
                </a>
                <a data-role="button" data-transition="fade" href="#page1" id="exchangebutton">
                    Exchange APDU
                </a>
                <a data-role="button" data-transition="fade" href="#page1" id="closebutton">
                    Close Channel
                </a>
            </div>
        </div>
        <script>
          // Applet ID
          var aid = [0xD2, 0x76, 0x00, 0x01, 0x18, 0x00, 0x02, 0xFF, 0x49, 0x50, 0x25, 0x89, 0xC0, 0x01, 0x9B, 0x01];
          //var apdu = [0x90, 0x10, 0x00, 0x00, 0x00];
          var apdu = {
            cla: 0x90,
            command: 0x10,
            p1: 0x00,
            p2: 0x00,
            p3: 0x00,
            path: null,
            data: null,
            data2: null
          };
          var channelId = 0;
          var transmitResult = null;

          $(document).ready(function () {
            $("#openbutton").bind("click", function(event, ui) {
                var aidstr = arrayToHexStr(aid);
                // Open channel to applet ID
                iccOpenChannel(aidstr);
              }
            );
            $("#exchangebutton").bind("click", function(event, ui) {
                // Issue command to open channelID (associated with AppletID)
                if (!isValidChannel(channelId)) {
                  appendTextAndScroll("#output", "Not a valid channel to transmit.");
                  return;
                }
                iccExchangeAPDU(channelId, apdu);
              }
            );
            $("#closebutton").bind("click", function(event, ui) {
                if (!isValidChannel(channelId)) {
                  appendTextAndScroll("#output", "Not a valid channel to close.");
                  return;
                }
                // Close channel to applet.
                iccCloseChannel(channelId);
              }
            );
          });

          // Utils
          function arrayToHexStr(array) {
            var hexStr = array.map(function (x) {
              x = x.toString(16); // to hex
              x = ("00" + x).slice(-2);
              return x;
            }).join('');
            return hexStr;
          }

          function hexStringToString(hexstr) {
            var str = "";
            for (var i = 0; i < hexstr.length; i+=2) {
               var charCode = parseInt(hexstr.substr(i,2), 16);
               str += String.fromCharCode(charCode);
            }
            return str;
          }

          function isValidChannel(channel) {
            if (channelId <= 0 || channelId == null || channelId == undefined) {
              return false;
            }
            return true;
          }

          function appendTextAndScroll(htmlElementRef, message) {
            var htmlElement = $(htmlElementRef);
            htmlElement.val(htmlElement.val()+message+"\n");
            // TODO: The animation starts scrollTop at "0" every time, rather than scroll from current position.
            htmlElement.animate({ scrollTop: htmlElement.prop("scrollHeight") - htmlElement.height() }, 0);
          }

          // UICC applet commands
          function iccOpenChannel(aidhexstr) {
            var req = window.navigator.mozTelephony.iccOpenChannel(aidhexstr);
            req.onsuccess = function() {
              appendTextAndScroll("#output",
                "INFO: Open returns success. Channel: (" + JSON.stringify(this.result) + ")");
              if (channelId === undefined) {
                appendTextAndScroll("#output",
                  "INFO: Channel ID not defined. All channels in use. You can try again.");
              } else {
                channelId = this.result;
              }
            }
            req.onerror = function() {
              appendTextAndScroll("#output",
                "ERROR: Open Failure! Return data: (" + JSON.stringify(this.error) + ")");
            }
          }

          function iccExchangeAPDU(channelId, apdu) {
            var req = window.navigator.mozTelephony.iccExchangeAPDU(
                        channelId, apdu);
            req.onsuccess = function() {
              appendTextAndScroll("#output",
                "INFO: APDU Exchange Success! Return data: (" + JSON.stringify(this.result) + ")");
              transmitResult = hexStringToString(this.result[2]);
              appendTextAndScroll("#output", "INFO: String Result: " + transmitResult);
            }
            req.onerror = function() {
              appendTextAndScroll("#output",
                "ERROR: APDU Exchange Failure! Return data: (" + JSON.stringify(this.result) + ")");
            }
          }

          function iccCloseChannel(channelId) {
            var req = window.navigator.mozTelephony.iccCloseChannel(channelId);
            req.onsuccess = function() {
              appendTextAndScroll("#output",
                "INFO: Close Success! Return data: (" + JSON.stringify(this.result) + ")");
            }
            req.onerror = function() {
              appendTextAndScroll("#output",
                "ERROR: Close Failure! Return data: (" + JSON.stringify(this.error) + ")");
            }
            channelId = 0;
          }
        </script>
    </body>
</html>

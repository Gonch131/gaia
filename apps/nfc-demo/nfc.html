<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="jquery.mobile-1.0.1.min.css" />
        <style>
          [data-role=page]{height: 100% !important; position:relative !important;}
          [data-role=footer]{bottom:0; position:absolute !important; top: auto !important; width:100%;} 
        </style>
        <script src="jquery-1.6.4.min.js">
        </script>
        <script src="jquery.mobile-1.0.1.min.js">
        </script>
        <script src="js/nfc_consts.js">
        </script>
        <script src="js/nfc_util.js">
        </script>
        <script src="js/nfc_writer.js">
        </script>
        <script>
          var isListening = false;

          $(document).ready(function () {
            $("#startbutton").bind( "click", function(event, ui) {
              if(isListening == false) {
                $("#buttontext").text("Stop Tag Discovery");
                isListening = true;
                addNdefListener();
                addTagLostListener();
              } else {
                $("#buttontext").text("Start Tag Discovery");
                $("#taglist").css("display", "none");
                $("#actionlist").css("display", "none");
                isListening = false;
                removeNdefListener();
              }
            });
          });

          function handleWellKnownRecord(record) {
            if(record.type == nfc.rtd_text) {
              return handleTextRecord(record);
            } else if(record.type == nfc.rtd_uri) {
              return handleURIRecord(record);
            } else if(record.type == nfc.rtd_smart_poster) {
              return handleSmartPosterRecord(record);
            } else {
              console.log("Unknown record type: " + record.type);
            }
          }

          function handleTextRecord(record) {
            var status = record.payload.charCodeAt(0);
            var languageLength = status & nfc.rtd_text_iana_length;
            var language = record.payload.substring(1, languageLength + 1);
            var encoding = status & nfc.rtd_text_encoding;
            var text;
            var encodingString;
            if(encoding == nfc.rtd_text_utf8) {
              text = decodeURIComponent(escape(record.payload.substring(languageLength + 1)));
              encodingString='UTF-8';
            } else if(encoding == nfc.rtd_text_utf16) {
              record.payload.substring(languageLength + 1);
              encodingString='UTF-16';
            }
            return {'action': 'Display text', 'text': text, 'language': language, 'encoding': encodingString };
          }

          function handleURIRecord(record) {
            var prefix = nfc.uris[record.payload.charCodeAt(0)];
            if(record.payload.substring(1).indexOf("dl.dropbox.com/u/7530841/")>=0) {
              return {'action': 'Purchase', 'uri': "http://192.168.1.108/~arno/mc/?purchase_url=" + prefix + record.payload.substring(1) };
            } else {
              return {'action': 'Open URI', 'uri': prefix + record.payload.substring(1) };
            }
          }

          function handleVCardRecord(record) {
            var name = record.payload.substring(record.payload.indexOf("FN:") + "FN:".length);
            name = name.substring(0, name.indexOf("\n"));
            var first = name.substring(0, name.indexOf(" "));
            var last = name.substring(name.indexOf(" ")+1);
            var cell = record.payload.substring(record.payload.indexOf("CELL:") + "CELL:".length);
            cell = cell.substring(0, cell.indexOf("\n"));
            return {'action': 'Add to contacts', 'first': first, 'last': last, 'cell': cell  };
          }

          function handleSmartPosterRecord(record) {
            var ret = new Array();
            do {
              var tnf = record.payload.charCodeAt(0) & nfc.flags_tnf;

              var typeLength = record.payload.charCodeAt(1);

              var payloadLength = 0;
              var isShortRecord = (record.payload.charCodeAt(0) & nfc.flags_ss) > 0;
              if(isShortRecord) {
                payloadLength = record.payload.charCodeAt(2);
              } else {
                payloadLength = (record.payload.charCodeAt(2) << 32) + record.payload.charCodeAt(3);
              }

              var idLength = 0;
              var isIdPresent = (record.payload.charCodeAt(0) & nfc.flags_il) > 0;
              if(isIdPresent) {
                idLength = record.payload.charCodeAt(isShortRecord ? 3 : 4);
              } else {
                idLength = 0;
              }

              var offset = 1 + 1 + (isShortRecord ? 1 : 2) + (isIdPresent ? 1 : 0);
              var type = record.payload.substring(offset, offset + typeLength);
              offset += typeLength;

              var id = isIdPresent ? record.payload.substring(offset, offset + idLength) : "";
              offset += idLength;
  
              var payload = record.payload.substring(offset, offset + payloadLength);
              offset += payloadLength;

              var subrecord = { 'tnf': tnf, 'type': type, 'id': id, 'payload': payload };
              console.log("SUBRECORD: " + JSON.stringify(subrecord));
              ret.push(subrecord);
              record.payload = record.payload.substring(offset);
            } while(record.payload.length > 0);
            return { 'action': 'Smart Poster', 'records' : ret };
          }

          function getRecordActionText(record, handle) {
            if(record.type == nfc.rtd_text) {
              return 'text: ' + handle.text + ' (Language: ' + handle.language + ', Encoding: ' + handle.encoding + ')';
            } else if(record.type == nfc.rtd_uri) {
              if(handle.uri.indexOf("tel")==0) {
                return '<a href="javascript:launchDialer(\'' + handle.uri + '\')">' + handle.uri + '</a>';
              } else {
                return '<a href="javascript:launchBrowser(\'' + handle.uri + '\')">' + handle.uri + '</a>';
              }
            } else if(record.type == "text/x-vCard") {
                return '<a href="javascript:addContact(\'' + handle.first + '\', \'' + handle.last + '\', \'' + handle.cell + '\')">' + 
                       'first name: ' + handle.first + '<br/>last name: ' + handle.last + '<br/>cell: ' + handle.cell + '</a>';
            }
          }

          function addContact(first, last, cell) {
            var contact = new mozContact();

            contact.givenName = first;
            contact.familyName = last;
            contact.name = contact.givenName + ' ' + contact.familyName;

            contact.tel = [cell];
            contact.email = '';

            var req = navigator.mozContacts.save(contact);
            req.onsuccess = (function() {
              debug("Added contact successfully");
            });
          }

          function launchDialer(telurl) {
            var number = telurl.substring("tel:".length);
            console.log("Adding number " + number + " to settings");
            if (navigator.mozSettings) {
              var request = navigator.mozSettings.getLock().set({ 'nfc.dial_number': number});
              request.onsuccess = function() {
                launchDialerApp();
              }
              request.onerror = function() {
                console.log("error");
              }
            }
          }

          function launchDialerApp() {
	    console.log("Searching for dialer app");
            navigator.mozApps.mgmt.getAll().onsuccess = function(e) {
	      console.log("Got all apps");
              var apps = e.target.result;
              apps.forEach(function(app) {
	        console.log("Discovered app: " + app.origin);
                if(app.origin.indexOf("dialer")>=0) {
	          console.log("Launching dialer app");
                  app.launch();
                }
              });
            };
          }

          function launchBrowser(url) {
            console.log("Adding url " + url + " to settings");
            if (navigator.mozSettings) {
              var request = navigator.mozSettings.getLock().set({ 'nfc.open_url': url});
              request.onsuccess = function() {
                launchBrowserApp();
              }
              request.onerror = function() {
                console.log("error");
              }
            }
          }

          function launchBrowserApp() {
            console.log("Searching for browser app");
            navigator.mozApps.mgmt.getAll().onsuccess = function(e) {
              console.log("Got all apps");
              var apps = e.target.result;
              apps.forEach(function(app) {
                console.log("Discovered app: " + app.origin);
                if(app.origin.indexOf("browser")>=0) {
                  console.log("Launching browser app");
                  app.launch();
                }
              });
            };
          }

          function addNdefListener() {
            debug("Starting Tag Discovery...");

            // Ndef Discovery
            navigator.mozNfc.onndefdiscovered = function(event) {
              debug("Found tag!");
              $("#taglist").css("display", "inline");
              $("#actionlist").css("display", "inline");

              var html ='<li data-role="list-divider" role="heading">NDEF Tag</li>';

              for (var i = 0; i < event.ndefMessages.length; i++) {
                var record = event.ndefMessages[i];
                console.log("RECORD: " + JSON.stringify(record));

                //Dump generic data
                html+='<li data-theme="c">';
                html+='tnf: ' + record.tnf + '<br/>';
                html+='type: ' + record.type + '<br/>';
                html+='id: ' + record.id + '<br/>';
                html+='raw payload: ' + record.payload + '<br/>';
                html+='</li>';

                var action="";
                if(record.tnf == nfc.tnf_well_known) {
                  var handle = handleWellKnownRecord(record);
                  action +='<li data-role="list-divider" role="heading">Action: ' + handle.action + '</li>';
                  action +='<li data-theme="c">';
                  if(record.type == nfc.rtd_smart_poster) {
                    for(var j = 0; j < handle.records.length; j++) {
                      var subRecord = handle.records[j];
                      var subHandle = handleWellKnownRecord(subRecord);
                      action += getRecordActionText(subRecord, subHandle);
                      if(j < handle.records.length - 1) {
                        action +='</li>';
                        action +='<li data-theme="c">';
                      }
                    }
                  } else {
                    action += getRecordActionText(record, handle);
                  }
                  action +='</li>';
                } else if(record.tnf == nfc.tnf_absolute_uri) {
                  action +='<li data-role="list-divider" role="heading">Action: Open URI</li>';
                  action +='<li data-theme="c">';
                  action += handleURIRecord(record);
		  action +='</li>';
		} else if(record.tnf == nfc.tnf_mime_media) {
			if(record.type == "text/x-vCard") {
				action +='<li data-role="list-divider" role="heading">Action: Add to Contacts</li>';
				action +='<li data-theme="c">';
				action += getRecordActionText(record, handleVCardRecord(record));
				action +='</li>';
			}
		}
	      }

	      $("#taglist").html(html);
	      $("#taglist").listview("refresh");

	      $("#actionlist").html(action);
	      $("#actionlist").listview("refresh");
	    };
	  }

          function removeNdefListener() {
	    debug("Stopping Tag Discovery...");
	    navigator.mozNfc.onndefdiscovered = null;
          }

          function addTagLostListener() {
	    navigator.mozNfc.ontaglost = function(event) {
              var messageType = event.ndefMessages.type;
              var content = event.ndefMessages.content;
              if (messageType == "tagLost") {
                var message = "Tag no longer in range. Tag HandleId: " + content.handleId;
                console.log(message);
                $('#area').val($('#area').val()+message+"\n");
              }
            }
          }

          function debug(message) {
            console.log("DEBUG:" + message);
            $('#area').val($('#area').val()+message+"\n"); 
          }
	</script>
    </head>
    <body>
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    NFC Demo - Deutsche Telekom
                </h3>
            </div>
            <div id="NFCTagReader" data-role="content">
                <h2>NFC Tag Reader</h2>
                <a data-role="button" data-transition="fade" href="#page1" id="startbutton">
                    <span id="buttontext">Start Tag Discovery</span>
                </a>
                <ul data-role="listview" data-divider-theme="b" data-inset="true">
                    <li data-role="list-divider" role="heading">
                        Status
                    </li>
                    <li data-theme="c" style="height: 100%">
                      <textarea id="area" placeholder="" style="width:100%; padding: 0; height: auto" rows="6" readonly="readonly" disabled="true"></textarea>
                    </li>
                </ul>
                <ul data-role="listview" data-divider-theme="b" data-inset="true" id="taglist" style="display: none;">
                    <li data-role="list-divider" role="heading">
                        NdefMessage
                    </li>
                </ul>
                &nbsp;
                <ul data-role="listview" data-divider-theme="b" data-inset="true" id="actionlist" style="display: none;">
                    <li data-role="list-divider" role="heading">
                        Action
                    </li>
                </ul>
            </div>

            <!-- NFC Tag Writer div -->
            <div id="NFCTagWriter" data-role="collapsible">
                <h2>NFC Tag Writer</h2>
                <div id="nfc_contact_form_id">
                    <h3>Contact Write</h3>
                    <label for="basic">Type Name Format</label>
                    <input id="nfc_contact_tnf_id" type="text" name="nfc_contact_tnf_name" value="2"/>

                    <label for="basic">Type</label>
                    <input id="nfc_contact_type_id" type="text" name="nfc_contact_type_name" value="text/x-vCard"/>

                    <label for="basic">Id</label>
                    <input id="nfc_contact_id_id" type="text" name="nfc_contact_type_name" value=""/>

                    <br>
                    <label for="basic">First</label>
                    <input id="nfc_contact_payload_name_first_id"
                        type="text" name="nfc_contact_payload_name_first" value=""/>
                    <br>
                    <label for="basic">Last</label>
                    <input id="nfc_contact_payload_name_last_id"
                        type="text" name="nfc_contact_payload_name_last" value=""/>
                    <br>
                    <label for="basic">Middle 1</label>
                    <input id="nfc_contact_payload_name_middle_1_id"
                        type="text" name="nfc_contact_payload_name_middle_1" value=""/>
                    <br>
                    <label for="basic">Middle 2</label>
                    <input id="nfc_contact_payload_name_middle_2_id"
                        type="text" name="nfc_contact_payload_name_middle_2" value=""/>

                    <label for="basic">FullName</label>
                    <input id="nfc_contact_payload_name_fullname_id"
                        type="text" name="nfc_contact_payload_name_fullname" value=""/>

                    <label for="basic">Telephone</label>
                    <input id="nfc_contact_payload_telephone_id"
                        type="text" name="nfc_contact_payload_telephone" value=""/>

                    <label for="basic">Mobile</label>
                    <input id="nfc_contact_payload_mobile_id"
                        type="text" name="nfc_contact_payload_mobile" value=""/>

                    <div>
                        <script>
                        // inital form logic before submission
                        // disable some input fields
                        $("#nfc_contact_form_id #nfc_contact_tnf_id").prop('disabled', true);
                        $("#nfc_contact_form_id #nfc_contact_type_id").prop('disabled', true);
                        $("#nfc_contact_form_id #nfc_contact_id_id").prop('disabled', true);
                        function writeContactFormToNdef() {
                            // writeContactArrayTag will write a contact array as the payload.
                            var record = contactFormToNdefRecord();
                            var pending = writeContactTag(record);
                            if (pending != null) {
                                pending.onsuccess = function() {
                                    var msg = this.result;
                                    var message = "Ndef Write Successful. RequestId: " + msg.requestId + ", Result: " + msg.status;
                                    console.log(message);
                                    $('#area').val($('#area').val()+message+"\n");
                                }
                                pending.onerror = function() {
                                    var msg = this.result;
                                    var message = "Error writing tag. RequestId: " + msg.requestId + ", Result: " + msg.status + ", Error text: " + this.error.message;
                                    console.log(message);
                                    $('#area').val($('#area').val()+message+"\n");
                                }
                            }
                        }
                        </script>
                        <br/>
                        <button onclick="writeContactFormToNdef();">Write Contact Tag</button>
                    </div>
                </div>
            </div>


            <div data-theme="a" data-role="footer">
                <h3>
                    by Deutsche Telekom
                </h3>
            </div>
        </div>
        <script>
            //App custom javascript
        </script>
    </body>
</html>
